// Generated by CoffeeScript 1.4.0
(function() {
  var Bot, Pitboss, fs, request, retrieveBot, util;

  fs = require('fs');

  request = require('request');

  util = require('util');

  Pitboss = require('pitboss').Pitboss;

  Bot = (function() {

    function Bot(opts) {
      var _base;
      this.opts = opts;
      this.opts || (this.opts = {});
      this.name = this.opts['name'] || "Unnamed";
      (_base = this.opts)['brainSize'] || (_base['brainSize'] = 4096);
      this.brain = {};
      this.loaded = false;
    }

    Bot.prototype.setup = function(code) {
      code = "// Debug setup\nvar debug = [];\nvar console = {};\nconsole.log = function(txt){debug.push(txt)};\n\n// CommonJS compat\nvar module = {};\nvar exports = module.exports = {};\n" + code + ";\nvar result = {}\nvar bet = exports.play(game);\nresult = {\n  bet: bet,\n  brain: game.self.brain,\n  debug: debug\n}\nresult // Return results to Pitboss";
      this.player = new Pitboss(code, this.opts);
      return this.loaded = true;
    };

    Bot.prototype.update = function(game, callback) {
      var _this = this;
      game.self.brain = this.brain;
      return this.player.run({
        game: game
      }, function(err, result) {
        var debug, _i, _len, _ref;
        if (err) {
          return callback(err);
        } else {
          if (_this.opts['debug']) {
            _ref = result['debug'];
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              debug = _ref[_i];
              console.log(util.inspect(debug, false, 6));
            }
          }
          _this.saveBrain(result['brain']);
          return typeof callback === "function" ? callback(null, result['bet']) : void 0;
        }
      });
    };

    Bot.prototype.saveBrain = function(brainObj) {
      var length;
      length = JSON.stringify(brainObj || {});
      if (length > this.opts['brainSize']) {
        return this.brain = {};
      } else {
        return this.brain = brainObj;
      }
    };

    return Bot;

  })();

  exports.create = function(id, opts, callback) {
    var bot;
    bot = new Bot(opts);
    console.log("Creating bot for - " + id);
    retrieveBot(id, function(err, code) {
      return bot.setup(code);
    });
    return bot;
  };

  retrieveBot = function(id, callback) {
    if (id.match(/^http/)) {
      return request(id, function(err, response, body) {
        if (err) {
          return typeof callback === "function" ? callback(err) : void 0;
        } else {
          return typeof callback === "function" ? callback(null, body.toString()) : void 0;
        }
      });
    } else {
      return fs.readFile(id, function(err, data) {
        if (err) {
          return typeof callback === "function" ? callback(err) : void 0;
        } else {
          return typeof callback === "function" ? callback(null, data.toString()) : void 0;
        }
      });
    }
  };

}).call(this);
